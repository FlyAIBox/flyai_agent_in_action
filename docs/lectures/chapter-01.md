# 第一章：Agent 基础入门（讲义）

## 理论基础：LangGraph 简介与动机

### 1.1 单一大语言模型（LLM）的局限性

一个单独的大语言模型功能其实非常有限。例如，它缺乏对以下内容的天然支持：

* **工具的调用**：无法直接访问外部系统、API 或数据库
* **外部上下文的接入**：无法获取实时信息或特定领域知识
* **多步骤的工作流**：无法执行复杂的、需要多个步骤的任务

**传统 LLM 应用架构**：
```
开始 → LLM → 结束
```

这种简单的架构限制了 LLM 在实际应用中的能力。

### 1.2 控制流的引入

因此，许多基于 LLM 的应用程序都会采用"控制流（control flow）"，在调用 LLM 之前或之后增加额外的步骤：

* **工具调用**：让 LLM 能够使用计算器、搜索引擎、数据库等
* **信息检索**：从知识库、文档或互联网获取相关信息
* **结果后处理**：格式化、验证或进一步处理 LLM 的输出

**增强后的架构**：
```
开始 → Step 1 → LLM → Step N → 结束
```

### 1.3 链（Chain）的概念

这种控制流就构成了所谓的"链（Chain）"。链将步骤串联起来，定义了固定的执行顺序。

**链的特点**：
- **可靠性**：控制流是固定的，每次执行都遵循同样的模式
- **可预测性**：开发者完全控制执行路径
- **局限性**：缺乏动态决策能力

**链的示例架构**：
```
┌─────────────────────────────────┐
│ Chain                           │
│ Step 1 → LLM → Step N          │
└─────────────────────────────────┘
```

### 1.4 对更灵活系统的需求

在实践中，我们希望 LLM 系统能够自行选择控制流，而不是仅仅依赖固定的链。

**动态控制流的需求**：
- 根据用户输入选择不同的处理路径
- 基于中间结果决定下一步行动
- 在运行时动态调整执行策略

**灵活执行示例**：
```
调用 1: Step 1 → Step 2 → 结束
调用 2: Step 1 → Step N → 结束
```

### 1.5 Agent 的核心概念

**Agent ≈ 由 LLM 决定的控制流**

Agent 不仅仅是执行固定流程，而是让 LLM 动态决定调用的步骤和顺序。

**Agent 的关键特征**：
- **自主决策**：LLM 在运行时选择执行路径
- **工具使用**：能够调用各种外部工具和服务
- **状态管理**：维护执行过程中的状态信息
- **错误恢复**：能够处理异常情况并重新规划

### 1.6 固定控制流 vs LLM 决定的控制流

| 特性 | 固定链（Chain） | Agent |
|------|----------------|-------|
| **控制方式** | 开发时预定义 | LLM 动态选择 |
| **可靠性** | 高（可预测） | 中等（不确定性） |
| **灵活性** | 低（固定路径） | 高（动态路径） |
| **复杂性** | 简单 | 复杂 |
| **调试难度** | 低 | 高 |

### 1.7 多种类型的 Agent

Agent 的种类非常多，在控制程度和灵活性之间形成谱系：

**Router（路由型）**：
- 控制程度较强
- LLM 仅在某些分支上做决策
- 适合有明确分类需求的场景

**Fully Autonomous（完全自治型）**：
- LLM 几乎完全掌控控制流
- 自动选择步骤和工具
- 适合开放式任务

**控制-灵活性谱系**：
```
代码 → LLM调用/链 → 路由器 → 完全自治
高控制/低灵活  ←→  低控制/高灵活
```

### 1.8 实际挑战：可靠性与灵活性的权衡

在实践中，Agent 面临一个关键权衡问题：

- **灵活性**（Agency/Flexibility）高时，**可靠性**（Reliability）往往低
- **控制**（Control）越少，系统不可预测性越强

**权衡曲线**：
```
可靠性
  ↑
  |  ┌─代码
  |  |
  |  | ┌─链
  |  | |
  |  | | ┌─路由器
  |  | | |
  |  | | | ┌─完全自治
  |  | | | |
  └──┴─┴─┴─┴──→ 灵活性
```

### 1.9 LangGraph 的解决方案

**LangGraph 的目标**：在提供足够灵活性的同时，保持较高的可靠性。

**核心设计理念**：
- **开发者定义部分控制流**（保证可靠性）
- **LLM 决定其他部分**（保证灵活性）

**LangGraph 的位置**：
```
可靠性
  ↑
  |  ┌─代码
  |  |
  |  | ┌─链
  |  | |
  |  | | ┌─LangGraph  ← 最佳平衡点
  |  | | |
  |  | | | ┌─路由器
  |  | | | |
  |  | | | | ┌─完全自治
  |  | | | | |
  └──┴─┴─┴─┴─┴──→ 灵活性
```

### 1.10 图结构化表达

LangGraph 将这种思路用**图（Graph）**来表示：

**图的组件**：
- **节点（Node）**：表示一个步骤或操作
- **边（Edge）**：连接节点，定义控制流
- **状态（State）**：在整个图中共享的数据
- **LLM 决策点**：根据状态动态选择路径

**图结构示例**：
```
开始 → 节点1 → [LLM决策] → 节点2A
                         → 节点2B → 结束
```

**LangGraph 的优势**：
- **可视化**：图结构易于理解和调试
- **模块化**：节点可以独立开发和测试
- **可控性**：开发者定义图结构，LLM 选择路径
- **可扩展性**：易于添加新的节点和路径

## 1. 3 分钟了解 Agent 与 LangGraph
- 学习目标：
  - 明确 Agent 与传统程序架构差异
  - 掌握 LangGraph 的"精确性与控制力"设计理念
  - 了解 Chat Models 与生态组件
- 关键要点：
  - Agent 概念、组成与生命周期
  - LangGraph vs LangChain：图式编排与可控执行
  - 第一个 LangGraph 程序骨架与最小示例
- 实操关联：`01-agent-build/0-Introduce/basics.ipynb`
- 课后练习：
  - 用你熟悉的场景（如 FAQ）画出 Agent 执行图
  - 修改示例，添加一个"打印"节点并验证执行顺序

## 学习模块概览

| 模块 | 学习内容 |
|------|----------|
| **1: Foundations** | LangGraph 基础：Chains、Routers、通用自治型 Agent |
| **2: Memory** | 具备记忆能力的 Agent |
| **3: Human-In-The-Loop** | 具有人类监督的 Agent |
| **4: Customization** | 可定制、实用的 Agent |

## 1. Agent 开发环境搭建（实操）
- 学习目标：
  - 完成 Python/依赖安装与密钥配置
  - 启用 LangGraph Studio 并能在本地调试
- 步骤清单：
  - Python 3.12（或 ≥3.11），conda/pip 环境
  - 安装依赖与可选扩展；配置 OpenAI/Langfuse 密钥
  - 安装并启动 LangGraph Studio；Jupyter 配置
  - 常见问题排查（网络、SSL、代理、权限）

- 验收标准：
  - 能运行任一 Notebook 并呼起模型

## 2.简单图构建实战（实操）
- 学习目标：能编译/执行/可视化一个 3 节点图
- 要点：StateGraph、节点/边/状态、条件路由
- 实操：`01-agent-build/1-Base/01-simple-graph.ipynb`
- 练习：增加一个“回退”边并在 Studio 中调试

## 3. 链式调用与路由（实操）
- 学习目标：掌握链式/条件分支/路由与错误处理
- 要点：
  - 路由器设计与条件分发
  - 异常捕获与重试策略
- 实操：`01-agent-build/1-Base/02-chain.ipynb`，`03-router.ipynb`
- 练习：为不同意图走不同子链并统计命中率

## 4. 基础 Agent 开发（实操）
- 学习目标：明确 Agent vs Chain 区别与 ReAct 工具调用
- 要点：工具调用协议、错误处理、性能监控
- 实操：`01-agent-build/1-Base/04-agent.ipynb`
- 练习：接入一个检索工具并实现最小 ReAct 回答

## 5.  Agent 记忆系统基础（实操）
- 学习目标：
  - 理解 Checkpointer/会话记忆与状态持久化
  - 能在 SQLite 上正确保存/恢复对话状态
- 关键要点：
  - Checkpointer 读写与恢复语义
  - 记忆检索与清理策略
- 实操关联：`01-agent-build/1-Base/01-agent-memory.ipynb`
- 练习：将记忆窗口从 k 条改为基于 token 的修剪
## 5.1 案例：LangGraph Studio 部署（实操）
- 学习目标：部署与调试 Studio，观察运行轨迹
- 要点：可视化调试、实时监控、性能分析
- 实操：`01-agent-build/1-Base/06-deployment.ipynb`，`01-agent-build/1-Base/studio/`
- 练习：导出一次完整运行的可视化图并标注关键路径

